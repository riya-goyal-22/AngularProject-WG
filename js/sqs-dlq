AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template to create SQS queue with Dead Letter Queue and RedriveAllowPolicy'

Resources:
  # Dead Letter Queue
  DLQueueV2:
    Type: 'AWS::SQS::Queue'
    Properties:
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: Production
        - Key: Purpose
          Value: DeadLetterQueue

  # Main Queue
  MainQueueV2:
    Type: 'AWS::SQS::Queue'
    DependsOn: DLQueueV2
    Properties:
      VisibilityTimeout: 30
      MessageRetentionPeriod: 345600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt DLQueueV2.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: Production
        - Key: Purpose
          Value: MainQueue

  # Update DLQ RedriveAllowPolicy after both queues are created
  UpdateDLQPolicyV2:
      Type: 'AWS::SQS::QueuePolicy'
      DependsOn: MainQueueV2
      Properties:
        Queues: 
          - !Ref DLQueueV2
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: sqs.amazonaws.com
              Action:
                - sqs:SendMessage
              Resource: 
                !GetAtt DLQueueV2.Arn
              Condition:
                ArnEquals:
                  'aws:SourceArn':
                    !GetAtt MainQueueV2.Arn

Outputs:
  MainQueueURL:
    Description: 'URL of the main queue'
    Value: !Ref MainQueueV2

  MainQueueARN:
    Description: 'ARN of the main queue'
    Value: !GetAtt MainQueueV2.Arn

  DLQueueURL:
    Description: 'URL of the dead letter queue'
    Value: !Ref DLQueueV2

  DLQueueARN:
    Description: 'ARN of the dead letter queue'
    Value: !GetAtt DLQueueV2.Arn